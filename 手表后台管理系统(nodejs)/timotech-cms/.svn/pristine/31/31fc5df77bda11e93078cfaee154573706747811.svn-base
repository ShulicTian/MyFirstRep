<div class="easyui-layout" fit="true">
	<div data-options="region:'west',title:'组织列表',split:true" style="width:15%;">
		<table id="treegd"></table>
	</div>


	<div data-options="region:'east',border:false" style="width:85%;">
		<div class="easyui-layout" fit="true">

			<div data-options="region:'center',border:false">
								<div id="toolbar" class="datagrid-toolbar" style="height: 26px; padding: 2px; ">
									<div style="padding-top: 2px; text-indent: 5px;float: left">
										<input id="snSearch" class="easyui-searchbox" searcher="doSearch" prompt="请输入SN号" style="width: 200px; "/>
									</div>
									<div class="datagrid-btn-separator" style="margin-left: 6px"></div>
									<% if (current_user.isAdmin) { %>

									<div style="float: left">
										<a href="javascript:void(0)" class="easyui-linkbutton ubindDevice" iconCls="icon-redo" disabled="disabled" plain="true">解绑</a>
									</div>
									<% } %>
								</div>
								<table id="dgDevice" idField="sn" nowrap="false" rownumbers="true" singleSelect="true">
									<thead>
									<tr>
										<th field="sn" width="200">SN</th>
										<th field="organName" width="120">所属组织</th>
										<th field="sw_version" width="80">设备版本</th>
										<th field="iccid" width="150">ICCID</th>
										<th field="babyId" width="100" formatter="bindFormatter">绑定状态</th>
									</tr>
									</thead>
								</table>
							</div>
			<div data-options="region:'south',border:false,split:true" style="height: 31%;width:300px;">
				<div class="easyui-tabs" id="tables">
					<div title="通讯录">
						<table id='dgContact' rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
								<tr>
									<th field="nickName" width="30%">昵称</th>
									<th field="phone" width="30%">手机号码</th>
									<th field="otherPhone" width="30%">其他号码</th>
								</tr>
							</thead>
						</table>
					</div>
					<div title="好友">
						<table id="dgFriend" rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
								<tr>
									<th field="name" width="30%">名称</th>
									<th field="phone" width="30%">手机号码</th>
									<th field="otherPhone" width="30%">其他号码</th>
								</tr>
							</thead>
						</table>
					</div>
					<div title="通话记录">
						<table id="dgCallLog" rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
								<tr>
									<th field="userName" width="10%">联系人姓名</th>
									<th field="phone" width="10%">电话号码</th>
									<th field="in" width="10%">来电类型</th>
									<th field="callPeriod" width="10%">通话时长</th>
									<th field="address" width="30%">地址</th>
								</tr>
							</thead>
						</table>
					</div>
					<!--<div title="自动接听开关状态">
                        <table id="dgStatus" rownumbers="true" nowrap="false" singleSelect="true">
                            <thead>
                            <th field="status" width="31%">开关状态</th>
                            </thead>
                        </table>
                    </div>-->
					<div title="课堂模式">
						<table id="dgClassroom" rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
								<th field="mode" width="10%">当前模式</th>
							</thead>
						</table>
					</div>
					<div title="闹钟">
						<table id="dgAlarm" rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
								<th field="time" width="10%">闹钟时间</th>
								<th field="repeat" width="10%">是否周期性闹钟</th>
								<th field="days" width="10%">一周重复数据</th>
								<th field="state" width="10%">是否开启</th>
							</thead>
						</table>
					</div>
					<div title="其他设置">
						<table id="dgOther" rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
								<th field="paraName" width="10%">paraName</th>
								<th field="paraValue" width="10%">paraValue</th>
							</thead>
						</table>
					</div>
					<!--<div title="定位模式">
                        <table id="dgGPS" rownumbers="true" nowrap="false" singleSelect="true">
                            <thead>
                            </thead>
                        </table>
                    </div>
                    <div title="手表固件版本">
                        <table id="dgFirmware" rownumbers="true" nowrap="false" singleSelect="true">
                            <thead>
                            <th field="version">版本号</th>
                            </thead>
                        </table>
                    </div>-->

				</div>
			</div>

		</div>
	</div>
</div>
<script type="text/javascript">
	function bindFormatter(value, row) {
		return row.babyId ? '已绑定' : '未绑定';
	}

	var currentOrganId;
	var currentDevice;
	var babyId;
	$('#treegd').treegrid({
		url: '/admin/getdisplayorganlist',
		loader: datagridLoader,
		collapsible: true,
		singleSelect: true,
		showHeader: false,
		border: false,
		rownumbers: true,
		idField: 'organID',
		treeField: 'organName',
		columns: [[
			{field: 'organName', width: 195}
		]],
		onClickRow: function (row) {
			currentOrganId = row.organID;
			doSearch($('#snSearch').searchbox('getValue'));
		}
	});

	function doSearch(value) {
		$('#dgDevice').datagrid('options').queryParams = {organID: currentOrganId, SN: (value ? value : '')};
		$('#dgDevice').datagrid('reload');
	}

	$('#dgDevice').edatagrid({
		url: '/device/getdevicelist',
		loader: datagridLoader,
		fit: true,
		toolbar: '#toolbar',
		pagination: true,
		pageSize: 20,
		onClickRow: function (index, row) {
			currentDevice = row.sn;
			babyId = row.babyId;
            if (row.babyId) {
				$(".ubindDevice").linkbutton('enable');
			} else {
				$(".ubindDevice").linkbutton('disable');
			}
            doSearchContact(babyId);
            doSearchCallLog(babyId);
            doSearchClassroom(babyId);
            doSearchAlarm(babyId);
            doSearchFriend(babyId);
            doSearchOther(babyId);
		},
		onLoadSuccess: function () {
			$(this).datagrid("fixRownumber");
			$(".ubindDevice").linkbutton('disable');
		}
	});

	var page = $('#dgDevice').datagrid('getPager');
	$(page).pagination({
		pageSize: 20,
		pageList: [20, 50, 100, 200],
		displayMsg: '当前显示 {from} - {to} 条记录 共 {total} 条记录',
		beforePageText: '第',
		afterPageText: '页 共 {pages} 页'
	});

	$(function () {
		$(".ubindDevice").click(function () {
			if (currentOrganId && currentDevice) {
				$.messager.confirm('提示', '是否将设备 ' + currentDevice + ' 解绑？', function (r) {
					if (r) {
						postJSON("/device/ubind", {babyId: babyId}, function (data) {
							if (data.errcode === 0) {
								layerNoShadeAlert('解绑成功！');
								$('#dgDevice').datagrid('reload');
							} else {
								layerNoShadeAlert('解绑失败！');
							}
						});
					}
				});
			}
		});

	});

    $("#dgContact").edatagrid({
        url: "/device/getdgContact",
        loader: datagridLoader,
        rownumbers: true,
        border: false,
        nowrap: false,
    });
    function doSearchContact(babyId){
        $('#dgContact').datagrid('options').queryParams = {babyId:babyId};
        $('#dgContact').datagrid('reload');
    }

    $("#dgCallLog").edatagrid({
        url: "/device/getdgCallLog",
        loader: datagridLoader,
        rownumbers: true,
        border: false,
        nowrap: false,
    });
    function doSearchCallLog(babyId){
        $('#dgCallLog').datagrid('options').queryParams = {babyId:babyId};
        $('#dgCallLog').datagrid('reload');
    }

    $("#dgClassroom").edatagrid({
        url: "/device/getdgClassroom",
        loader: datagridLoader,
        rownumbers: true,
        border: false,
        nowrap: false
    });
    function doSearchClassroom(babyId){
        $('#dgClassroom').datagrid('options').queryParams = {babyId:babyId};
        $('#dgClassroom').datagrid('reload');
    }

    $("#dgAlarm").edatagrid({
        url: "/device/getdgAlarm",
        loader: datagridLoader,
        rownumbers: true,
        border: false,
        nowrap: false
    });
    function doSearchAlarm(babyId){
        $('#dgAlarm').datagrid('options').queryParams = {babyId:babyId};
        $('#dgAlarm').datagrid('reload');
    }

    $("#dgFriend").edatagrid({
        url: "/device/getdgFriends",
        loader: datagridLoader,
        rownumbers: true,
        border: false,
        nowrap: false
    });
    function doSearchFriend(babyId){
        $('#dgFriend').datagrid('options').queryParams = {babyId:babyId};
        $('#dgFriend').datagrid('reload');
    }

    $("#dgOther").edatagrid({
        url: "/device/getdgOther",
        loader: datagridLoader,
        rownumbers: true,
        border: false,
        nowrap: false
    });
    function doSearchOther(babyId){
        $('#dgOther').datagrid('options').queryParams = {babyId:babyId};
        $('#dgOther').datagrid('reload');
    }

/*    $("#dgGPS").edatagrid({
        url: "/device/getdgGPS",
        loader: datagridLoader,
        rownumbers: true,
        border: false,
        nowrap: false
    });
    function doSearchGPS(babyId){
        $('#dgGPS').datagrid('options').queryParams = {babyId:babyId};
        $('#dgGPS').datagrid('reload');
    }

    $("#dgFirmware").edatagrid({
        url: "/device/getdgFirmware",
        loader: datagridLoader,
        rownumbers: true,
        border: false,
        nowrap: false
    });
    function doSearchFirmware(babyId){
        $('#dgFirmware').datagrid('options').queryParams = {babyId:babyId};
        $('#dgFirmware').datagrid('reload');
    }*/
    /*$("#dgStatus").edatagrid({
            url: "/device/getdgStatus",
            loader: datagridLoader,
            rownumbers: true,
            border: false,
            nowrap: false
        });
        function doSearchStatus(babyId){
            $('#dgStatus').datagrid('options').queryParams = {babyId:babyId};
            $('#dgStatus').datagrid('reload');
        }*/
    // var page1 = $('#tables table').datagrid('getPager');
    // $(page1).pagination({
    //     pageSize: 10,
    //     pageList: [10, 20, 50, 100],
    //     displayMsg: '当前显示 {from} - {to} 条记录 共 {total} 条记录',
    //     beforePageText: '第',
    //     afterPageText: '页 共 {pages} 页'
    // });
</script>