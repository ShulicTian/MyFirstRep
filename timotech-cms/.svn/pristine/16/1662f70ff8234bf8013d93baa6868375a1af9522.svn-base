<div class="easyui-layout" fit="true">
	<div data-options="region:'west',title:'组织列表',split:true" style="width:15%;">
		<table id="treegd"></table>
	</div>


	<div data-options="region:'east',border:false" style="width:85%;">
		<div class="easyui-layout" fit="true">

			<div data-options="region:'center',border:false">
				<div id="toolbar" class="datagrid-toolbar" style="height: 26px; padding: 2px; ">
					<div style="padding-top: 2px; text-indent: 5px;float: left">
						<input id="snSearch" class="easyui-searchbox" searcher="doSearch" prompt="请输入SN号" style="width: 200px; "/>
					</div>
					<div class="datagrid-btn-separator" style="margin-left: 6px"></div>
					<% if (current_user.isAdmin) { %>

					<div style="float: left">
						<a href="javascript:void(0)" class="easyui-linkbutton ubindDevice" iconCls="icon-redo" disabled="disabled" plain="true">解绑</a>
					</div>
					<% } %>
				</div>
				<table id="dgDevice" idField="sn" nowrap="false" rownumbers="true" singleSelect="true">
					<thead>
					<tr>
						<th field="sn" width="200">SN</th>
						<th field="organName" width="120">所属组织</th>
						<th field="sw_version" width="80">设备版本</th>
						<th field="iccid" width="150">ICCID</th>
						<th field="babyId" width="100" formatter="bindFormatter">绑定状态</th>
					</tr>
					</thead>
				</table>
			</div>
			<div data-options="region:'south',border:false,split:true" style="height: 31%;width:300px;">
				<div class="easyui-tabs" id="tables">
					<div title="通讯录">
						<table id='dgContact' rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
							<tr>
								<th field="name" width="120">称呼</th>
								<th field="phone" width="100">手机号码</th>
								<th field="otherPhone" width="100">其他号码</th>
								<th field="role" width="100">角色</th>
							</tr>
							</thead>
						</table>
					</div>
					<div title="好友">
						<table id="dgFriend" rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
							<tr>
								<th field="name" width="120">称呼</th>
								<th field="phone" width="100">手机号码</th>
								<th field="otherPhone" width="100">其他号码</th>
							</tr>
							</thead>
						</table>
					</div>
					<div title="通话记录">
						<table id="dgCallLog" rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
							<tr>
								<th field="userName" width="120">联系人姓名</th>
								<th field="phone" width="100">电话号码</th>
								<th field="in" formatter="inFormatter" width="60">来电类型</th>
								<th field="callPeriod" width="60">通话时长</th>
								<th field="address" width="300">地址</th>
							</tr>
							</thead>
						</table>
					</div>

					<div title="课堂模式">
						<table id="dgScene" rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
							<th field="start" formatter="timeFormatter" width="100">开始时间</th>
							<th field="end" formatter="timeFormatter" width="100">结束时间</th>
							<th field="days" formatter="daysFormatter" width="200">重复</th>
							<th field="mode" formatter="modeFormatter" width="80">当前模式</th>
							<th field="state" formatter="stateFormatter" width="60">是否开启</th>
							</thead>
						</table>
					</div>
					<div title="闹钟">
						<table id="dgAlarm" rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
							<th field="time" formatter="timeFormatter" width="100">闹钟时间</th>
							<th field="repeat" formatter="repeatFormatter" width="100">是否周期性闹钟</th>
							<th field="days" formatter="daysFormatter" width="200">重复</th>
							<th field="state" formatter="stateFormatter" width="60">是否开启</th>
							</thead>
						</table>
					</div>
					<div title="其他设置">
						<table id="dgSetting" rownumbers="true" nowrap="false" singleSelect="true">
							<thead>
							<th field="paraName" width="120">参数名</th>
							<th field="paraValue" width="80">参数值</th>
							<th field="desc" width="300">参数描叙</th>
							</thead>
						</table>
					</div>
				</div>
			</div>

		</div>
	</div>
</div>
<script type="text/javascript">
	function bindFormatter(value, row) {
		return value ? '已绑定' : '未绑定';
	}

	function stateFormatter(value, row) {
		return value == 1 ? '开启' : '关闭';
	}

	function repeatFormatter(value, row) {
		return value == 1 ? '是' : '否';
	}

	function daysFormatter(value, row) {
		console.log(value);
		var ss = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
		var content = '';
		for (var i = 0; i < ss.length; i++) {
			if (value.charAt(i) == '1') {
				content += ss[i] + ' ';
			}
		}
		return content;
	}

	function timeFormatter(value, row) {
		return value.substr(value.length - 4, 2) + ':' + value.substr(value.length - 2, 2);
	}

	function inFormatter(value, row) {
		if (value == 0) {
			return '呼出';
		} else if (value == 1) {
			return '呼入'
		} else if (value == 2) {
			return '超能听'
		} else {
			return '拒接';
		}
	}

	function modeFormatter(value, row) {
		if (value == 0) {
			return '非课堂模式';
		} else if (value == 1) {
			return '静音模式'
		} else if (value == 2) {
			return '免打扰模式'
		} else {
			return '';
		}
	}

	var currentOrganId;
	var currentDevice;
	var babyId;
	$('#treegd').treegrid({
		url: '/admin/getdisplayorganlist',
		loader: datagridLoader,
		collapsible: true,
		singleSelect: true,
		showHeader: false,
		border: false,
		rownumbers: true,
		idField: 'organID',
		treeField: 'organName',
		columns: [[
			{field: 'organName', width: 195}
		]],
		onClickRow: function (row) {
			currentOrganId = row.organID;
			doSearch($('#snSearch').searchbox('getValue'));
		}
	});

	function doSearch(value) {
		$('#dgDevice').datagrid('options').queryParams = {organID: currentOrganId, SN: (value ? value : '')};
		$('#dgDevice').datagrid('reload');
	}

	$('#dgDevice').edatagrid({
		url: '/device/getdevicelist',
		loader: datagridLoader,
		fit: true,
		toolbar: '#toolbar',
		pagination: true,
		pageSize: 20,
		onClickRow: function (index, row) {
			currentDevice = row.sn;
			babyId = row.babyId || 0;
			if (row.babyId) {
				$(".ubindDevice").linkbutton('enable');
			} else {
				$(".ubindDevice").linkbutton('disable');
			}
			doSearchContact(babyId);
			doSearchCallLog(babyId);
			doSearchScene(babyId);
			doSearchAlarm(babyId);
			doSearchFriend(babyId);
			doSearchSetting(babyId);
		},
		onLoadSuccess: function () {
			$(this).datagrid("fixRownumber");
			$(".ubindDevice").linkbutton('disable');
		}
	});

	var page = $('#dgDevice').datagrid('getPager');
	$(page).pagination({
		pageSize: 20,
		pageList: [20, 50, 100, 200],
		displayMsg: '当前显示 {from} - {to} 条记录 共 {total} 条记录',
		beforePageText: '第',
		afterPageText: '页 共 {pages} 页'
	});

	$(function () {
		$(".ubindDevice").click(function () {
			if (currentOrganId && currentDevice) {
				$.messager.confirm('提示', '是否将设备 ' + currentDevice + ' 解绑？', function (r) {
					if (r) {
						postJSON("/device/ubind", {babyId: babyId}, function (data) {
							if (data.errcode === 0) {
								layerNoShadeAlert('解绑成功！');
								$('#dgDevice').datagrid('reload');
							} else {
								layerNoShadeAlert('解绑失败！');
							}
						});
					}
				});
			}
		});

	});


	$("#dgContact").edatagrid({
		url: "/device/getContact",
		loader: datagridLoader,
		rownumbers: true,
		border: false,
		nowrap: false
	});
	function doSearchContact(babyId) {
		$('#dgContact').datagrid('options').queryParams = {babyId: babyId};
		$('#dgContact').datagrid('reload');
	}


	$("#dgCallLog").edatagrid({
		url: "/device/getCallLog",
		loader: datagridLoader,
		border: false,
		nowrap: false
	});
	function doSearchCallLog(babyId) {
		$('#dgCallLog').datagrid('options').queryParams = {babyId: babyId};
		$('#dgCallLog').datagrid('reload');
	}

	$("#dgScene").edatagrid({
		url: "/device/getScene",
		loader: datagridLoader,
		rownumbers: true,
		border: false,
		nowrap: false
	});
	function doSearchScene(babyId) {
		$('#dgScene').datagrid('options').queryParams = {babyId: babyId};
		$('#dgScene').datagrid('reload');
	}


	$("#dgAlarm").edatagrid({
		url: "/device/getAlarm",
		loader: datagridLoader,
		rownumbers: true,
		border: false,
		nowrap: false
	});
	function doSearchAlarm(babyId) {
		$('#dgAlarm').datagrid('options').queryParams = {babyId: babyId};
		$('#dgAlarm').datagrid('reload');
	}


	$("#dgFriend").edatagrid({
		url: "/device/getFriends",
		loader: datagridLoader,
		rownumbers: true,
		border: false,
		nowrap: false
	});
	function doSearchFriend(babyId) {
		$('#dgFriend').datagrid('options').queryParams = {babyId: babyId};
		$('#dgFriend').datagrid('reload');
	}

	$("#dgSetting").edatagrid({
		url: "/device/getSetting",
		loader: datagridLoader,
		rownumbers: true,
		border: false,
		nowrap: false
	});
	function doSearchSetting(babyId) {
		$('#dgSetting').datagrid('options').queryParams = {babyId: babyId};
		$('#dgSetting').datagrid('reload');
	}

</script>