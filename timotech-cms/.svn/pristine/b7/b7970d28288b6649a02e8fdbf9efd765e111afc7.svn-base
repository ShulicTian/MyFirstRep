<div class="easyui-layout" fit="true">
	<div data-options="region:'center',border:false">
		<% if (current_user.isAdmin) { %>
		<div id="toolbar" class="datagrid-toolbar">
			<div style="float: left">
				<a href="javascript:void(0)" class="easyui-linkbutton opbtn" iconCls="icon-add" plain="true" onclick="insert()" src="/resource/test">添加</a>
			</div>
			<div class="datagrid-btn-separator"></div>
			<div style="float: left">
				<a href="javascript:void(0)" class="easyui-linkbutton opbtn" iconCls="icon-edit" disabled="disabled" plain="true" onclick="edit()">编辑</a>
			</div>
			<div class="datagrid-btn-separator"></div>
			<div style="float: left">
				<a href="javascript:void(0)" class="easyui-linkbutton opbtn" iconCls="icon-remove" disabled="disabled" plain="true" onclick="deleteRow()">删除</a>
			</div>
			<div class="datagrid-btn-separator"></div>
			<div style="float: left">
				<a href="javascript:void(0)" class="easyui-linkbutton opbtn" iconCls="icon-save" plain="true" onclick="sendEmoticon()">发布</a>
			</div>
		</div>
		<% } %>
		<table id="audios">
			<thead>
			<tr>
				<th field="resourceId" width="200">表情ID</th>
				<th field="url" width="500">URL</th>
				<th field="version">版本</th>
				<th field="tag">标签</th>
			</tr>
			</thead>
		</table>
	</div>
</div>
<div id="dlg" class="easyui-dialog" style="width: 650px; height: 230px;margin:auto;padding: 10px 20px;"
     closed="true" buttons="#dlg-buttons">
	<form id="fm" method="post">
		<div style="margin-top:10px;margin-left:31px;">
			<label>表情ID&nbsp;&nbsp;&nbsp;</label><input name="resourceId" class="easyui-textbox tbinput1" id="resourceId" required="true"/>
		</div>
		<div style="margin-top:10px;margin-left:43px;">
			<label>版本&nbsp;&nbsp;&nbsp;</label><input name="version" class="easyui-textbox tbinput3" required="true"/>
		</div>
		<div style="margin-top:10px;margin-left:43px;">
			<label>标签&nbsp;&nbsp;&nbsp;</label><input name="tag" class="easyui-textbox tbinput4" required="true"/></div>
		<div style="margin-top:10px;margin-left:44px;">
			<label>URL&nbsp;&nbsp;&nbsp;</label><input name="url" class="easyui-textbox tbinput2" required="true" style="width:500px;"/>
		</div>
	</form>
</div>

<div id="dlg-buttons" style="height: 22px;">
	<div style="float: right">
		<a href="javascript:void(0)" class="easyui-linkbutton actionbtn" iconCls="icon-undo" plain="true" onclick="cancel()">取消</a>
	</div>
	<div class="datagrid-btn-separator" style="float: right"></div>
	<div class="datagrid-btn-separator" style="float: right"></div>
	<div style="float: right;">
		<a href="javascript:void(0)" class="easyui-linkbutton actionbtn" iconCls="icon-save" plain="true" onclick="save()">保存</a>
	</div>
</div>
<style type="text/css">
	#dlg {
		overflow: hidden;
	}

	#fm input {
		width: 250px;
	}
</style>
<script type="text/javascript">

	$('#audios').edatagrid({
		url: '/resource/getEmoticons',
		loader: datagridLoader,
		fit: true,
		onClickRow: function (index, row) {
			var resourceId = row.resourceId;
			var url = row.url;
			var version = row.version;
			var tag = row.tag;
			$(".opbtn").linkbutton('enable');
			$('#audios').datagrid('options').queryParams = {
				resourceId: resourceId,
				url: url,
				version: version,
				tag: tag
			};
		}
	});

	function deleteRow() {
		$.messager.confirm('确认', '确定删除吗？', function (confirm) {
			if (confirm) {
				var args = $('#audios').datagrid('options').queryParams;
				$.post("/resource/deleteEmoticon", args, function () {
					$('#audios').datagrid("reload");
				});
			}
		});
	}

	function edit() {
		$("#resourceId").textbox("textbox").attr('disabled', true);
		;
		var row = $("#audios").datagrid("getSelected");
		$("#fm").form("load", row);
		$("#dlg").dialog("open").dialog('setTitle', '编辑');
	}

	function insert() {
		$("#fm").children("div").children("input").textbox('setValue', null);
		$("#resourceId").textbox("textbox").attr('disabled', false);
		;
		$("#dlg").dialog("open").dialog('setTitle', '添加');
	}

	function save() {
		var title = $(".panel-title").html();
		var args = {
			"resourceId": $(".tbinput1").textbox('getValue'),
			"url": $(".tbinput2").textbox('getValue'),
			"version": $(".tbinput3").textbox('getValue')
		};
		if (judge(args)) {
		    args.tag=$(".tbinput4").textbox('getValue');
			if (title == "编辑") {

				$.post("/resource/updateEmoticon", args, function (data) {
					if (data.errmsg != null)
						layerNoShadeAlert(data.errmsg);
					$('#audios').datagrid("reload");
				});
			} else {
				$.post("/resource/saveEmoticon", args, function (data) {
					if (data.errmsg != null)
						layerNoShadeAlert(data.errmsg);
					$('#audios').datagrid("reload");
				});
			}
			$("#dlg").dialog("close");
		}
	}

	function cancel() {
		$("#dlg").dialog("close");
	}

	function sendEmoticon() {
		$.messager.confirm('确认', '确定发布吗？', function (confirm) {
			if (confirm) {
				$.post("/resource/publish", {resourceName: "emoticon"}, function (data) {
					layerNoShadeAlert(data.errmsg);
				});
			}
		});
	}
	function judge(args) {
		var temp = true;
		$.each(args, function (index, param) {
			if (param == null || param == "") {
				layer.msg('数据不能为空');
				temp = false;
			}
		});

		if (temp == false) {
			return false;
		}

		if (!(/^\d{1,}$/.test(args.version))) {
			layer.msg('Version只能是数字');
			return false;
		}
		return temp;
	}
</script>