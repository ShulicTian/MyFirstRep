<div class="easyui-layout" fit="true">
	<div data-options="region:'center',border:false">
		<div id="toolbar2" class="datagrid-toolbar" style="height: 26px; padding: 2px; ">
			<% if (current_user.isAdmin) { %>
			<div style="float: left">
				<a href="javascript:void(0)" class="easyui-linkbutton opbtn" iconCls="icon-add" plain="true" onclick="insert()">添加</a>
			</div>
			<div class="datagrid-btn-separator"></div>
			<!--		<div style="float: left">
						<a href="javascript:void(0)" class="easyui-linkbutton opbtn" iconCls="icon-edit" disabled="disabled" plain="true" onclick="edit()">编辑</a>
					</div>-->
			<div class="datagrid-btn-separator"></div>
			<div style="float: left">
				<a href="javascript:void(0)" class="easyui-linkbutton opbtn" iconCls="icon-remove" disabled="disabled" plain="true" onclick="deleteRow()">删除</a>
			</div>
			<% } %>
		</div>
		<table id="dgPackage" nowrap="false" rownumbers="true" singleSelect="true">
			<thead>
			<tr>
				<input type="hidden" name="id"/>
				<th field="product" width="100px">产品</th>
				<th field="name" width="100px">Name</th>
				<th field="fromVersion" width="100px">FromVersion</th>
				<th field="toVersion" width="100px">ToVersion</th>
				<th field="url" width="400px">URL</th>
				<th field="md5" width="250px">MD5</th>
				<th field="size" width="60px">Size</th>
				<th field="summary" width="300px">Summary</th>
			</tr>
			</thead>
		</table>
	</div>
</div>
<div id="dlg" class="easyui-dialog" style="width: 650px; height: 320px;margin:auto;padding: 10px 20px;"
     closed="true" buttons="#dlg-buttons">
	<form id="fm" method="post">
		<div style="margin-top:10px;margin-left:51px;">
			<label>产品&nbsp;&nbsp;&nbsp;</label><input name="product" class="easyui-combobox tbinput1" required="true" style="width: 150px;" data-options="
                valueField: 'key',
                textField: 'value',
                prompt: '请选择产品',
                data: [
                    { key: 'A100', value: 'A100' },
                    { key: 'A101', value: 'A101' },
                ]"/>
		</div>
		<div style="margin-top:10px;margin-left:1px;">
			<label>FromVersion&nbsp;&nbsp;&nbsp;</label><input name="fromVersion" class="easyui-textbox tbinput2" required="true"/>
		</div>
		<div style="margin-top:10px;margin-left:18px;">
			<label>ToVersion&nbsp;&nbsp;&nbsp;</label><input name="toVersion" class="easyui-textbox tbinput3" required="true"/>
		</div>
		<div style="margin-top:10px;margin-left:48px;">
			<label>文件&nbsp;&nbsp;&nbsp;</label>
			<input id="textboxFile" name="url" class="easyui-textbox tbinput4" value="" readonly style="width:300px;"/>

			<div class="easyui-linkbutton fileinput-button" id="btnImport" style="width:60px; margin-left: 10px;height:30px;margin-top:0px;">
				<span style="position: absolute">文件上传</span>
				<input type="file" name="files[]" multiple="" style="border-radius:3px;opacity:0;">
			</div>
		</div>

		<div style="margin-top:10px;margin-left:21px;">
			<label>Summary&nbsp;&nbsp;&nbsp;</label><input name="summary" class="easyui-textbox tbinput7" style="width:450px;"/>
		</div>
	</form>
</div>

<div id="dlg-buttons" style="height: 22px;">
	<div style="float: right">
		<a href="javascript:void(0)" class="easyui-linkbutton actionbtn" iconCls="icon-undo" plain="true" onclick="cancel()">取消</a>
	</div>
	<div class="datagrid-btn-separator" style="float: right"></div>
	<div class="datagrid-btn-separator" style="float: right"></div>
	<div style="float: right;">
		<a href="javascript:void(0)" class="easyui-linkbutton actionbtn" iconCls="icon-save" plain="true" onclick="save()">保存</a>
	</div>
</div>
<style type="text/css">
	#dlg {
		overflow: hidden;
	}

	#fm input {
		width: 250px;
		background-color: white;
	}
</style>
<script>

	$(function () {
		$('#btnImport').fileupload({
			maxFileSize: 60000000,
			url: '/device/uploadPackage/',
			acceptFileTypes: /(\.|\/)(bin|BIN)$/i,
			fileInput: $('#btnImport').find('input:file'),
			dataType: 'json',
			send: function () {
				layerShadeCenterAlert('文件上传中,请等待...');
			},
			done: function (e, data) {
				$('#textboxFile').textbox('setValue', data.result.retobj);
				layerNoShadeAlert(data.result.errmsg);
			}
		}).on('fileuploadprocessalways', function (e, data) {
			var index = data.index, file = data.files[index];
			if (file.error) {
				layerNoShadeAlert(file.error);
			}
		});
	});
	$('#dgPackage').edatagrid({
		url: '/device/getPackagelist',
		loader: datagridLoader,
		fit: true,
		toolbar: '#toolbar2',
		// pagination: true,
		// pageSize: 20,
		nowrap: true,
		onClickRow: function (index, row) {
			$('#dgPackage').datagrid('options').queryParams = {
				product: row.product,
				id: row.id,
				fromVersion: row.fromVersion,
				toVersion: row.toVersion,
				size: row.size,
				summary: row.summary,
				url: row.url,
				md5: row.md5
			};
			$(".opbtn").linkbutton('enable');
		}
	});


	function edit() {
		var row = $("#dgPackage").datagrid("getSelected");
		$("#fm").form("load", row);
		$("#dlg").dialog("open").dialog('setTitle', '编辑');
	}

	function insert() {
		$("#fm").children("div").children("input").textbox('setValue', null);
		$("#dlg").dialog("open").dialog('setTitle', '添加');
	}

	function deleteRow() {
		$.messager.confirm('确认', '确定删除吗？', function (confirm) {
			if (confirm) {
				var args = $('#dgPackage').datagrid('options').queryParams;
				$.post("/device/removePackage", args, function () {
					$('#dgPackage').datagrid("reload");
				});
			}
		});
	}

	function save() {
		var title = $(".panel-title").html();
		var args = {
			"fromVersion": $.trim($(".tbinput2").textbox('getValue')),
			"toVersion": $.trim($(".tbinput3").textbox('getValue')),
			"url": $.trim($(".tbinput4").textbox('getValue')),
			"product": $.trim($(".tbinput1").combobox('getValue'))
		};

		if (judge(args)) {
			args.summary = $.trim($(".tbinput7").textbox('getValue'));
			if (title == "编辑") {
				args.id = $('#dgPackage').datagrid('options').queryParams.id;
				$.post("/device/updatePackage", args, function (data) {
					if (data.errmsg != null)
						layerNoShadeAlert(data.errmsg);
					$('#dgPackage').datagrid("reload");
				});
			} else {
				$.post("/device/savePackage", args, function (data) {
					if (data.errmsg != null)
						layerNoShadeAlert(data.errmsg);
					$('#dgPackage').datagrid("reload");
				});
			}
			$("#dlg").dialog("close");
		}
	}

	function cancel() {
		$("#dlg").dialog("close");
	}

	function judge(args) {
		var temp = true;
		$.each(args, function (index, param) {
			if (param == null || param == "") {
				layer.msg('数据不能为空');
				temp = false;
			}
		});

		if (temp == false) {
			return false;
		}

		return temp;
	}
</script>