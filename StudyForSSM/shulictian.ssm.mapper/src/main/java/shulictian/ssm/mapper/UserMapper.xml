<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
        
<mapper namespace="shulictian.ssm.mapper.UserMapper">
	
	<resultMap type="userCustom" id="userCus">
		<id column="id" property="id"/>
<!-- 		<result column="username" property="userName"/>
		<result column="password" property="passWord"/> -->
		<result column="regTime" property="regTime"/>
		<result column="type" property="type"/>
		<result column="nickname" property="nickName"/>
		<result column="zeroNum" property="zeroNum"/>
		<result column="oneNum" property="oneNum"/>
		<result column="towNum" property="towNum"/>
		<result column="commentNum" property="commentNum"/>
		<result column="lookNum" property="lookNum"/>
		<result column="ranking" property="ranking"/>
		<result column="fansNum" property="fansNum"/>
		<result column="atteNum" property="atteNum"/>
		<result column="gitHome" property="gitHome"/>
		<collection property="prosAddress" ofType="proMsg">
			<result column="proadd" property="address"/>
			<result column="descs" property="descs"/>
			<result column="proName" property="name"/>
		</collection>
	</resultMap>
     
     <!-- 用户注册入库 -->   
    <insert id="saveUser" parameterType="user" useGeneratedKeys="true" keyProperty="id">
    	insert into user(username,password,regTime) value(#{userName},#{passWord},#{regTime})
    </insert>
    
    <insert id="createAdd" parameterType="int">
    	insert into proadds (user_id) value(#{userId})
    </insert>   
     
     <!-- 创建userstate -->   
    <insert id="createState" parameterType="int">
    	insert into userstate(user_id) value(#{id})
    </insert>
    
    <update id="updateState" parameterType="map">
    	<if test="map!=null">
    		update userstate
    		<set>
    			<if test="map.lookNum!=null">
    				lookNum=#{lookNum},
	    		</if>
	    		<if test="map.zeroNum!=null">
	    			zeroNum=#{zeroNum},
	    		</if>
	    		<if test="map.oneNum!=null">
	    			oneNum=#{oneNum},
	    		</if>
	    		<if test="map.towNum!=null">
	    			towNum=#{towNum},
	    		</if>
	    		<if test="map.commentNum!=null">
	    			commentNum=#{commentNum},
	    		</if>
	    		<if test="map.ranking!=null">
	    			ranking=#{ranking},
	    		</if>
	    		<if test="map.fansNum!=null">
	    			fansNum=#{fansNum},
	    		</if>
	    		<if test="map.atteNum!=null">
	    			atteNum=#{atteNum},
	    		</if>
    		</set>
    		where user_id=#{id}
    	</if>
    </update>   
     
     <!-- 根据账号密码获取用户 -->   
	<select id="getUser" parameterType="user" resultType="user">
		select * from user where username=#{userName} and password=#{passWord}
	</select>
	
	<!-- 更新昵称 -->   
	<update id="upUser" parameterType="user">
		update user set nickName=#{nickName} where id=#{id}
	</update>
	
	<!-- 更新密码 -->   
	<update id="upPwd" parameterType="map">
		update user set password=#{newPwd} where id=#{id}
	</update>
	
	<!-- 获取所有用户的用户名 -->
	<select id="getAllUserName" resultType="string">
		select username from user
	</select>
	
	<!-- 根据id查找User -->
	<select id="getUserById" parameterType="int" resultType="user">
		select id,nickname from user where id=#{id}
	</select>
	
	<!-- 根据id查找UserCus -->
	<select id="findUser" parameterType="int" resultMap="userCus">
		select u.nickname,u.type,us.*,p.proadd from user u,userstate us,proadds p where u.id=#{id} and us.user_id=u.id and p.user_id=u.id
	</select>
	
	<!-- 根据id查找用户粉丝 -->
	<select id="findFans" parameterType="int" resultType="user">
		select id,nickname,username from user where id in(select fans_id from fans where user_id=#{id} order by createTime desc)
	</select>
	
	<!-- 根据id查找用户已关注的用户 -->
	<select id="findAtt" parameterType="int" resultType="user">
		select id,nickname,username from user where id in(select user_id from fans where fans_id=#{id} order by createTime desc)
	</select>
	
	<insert id="createUsermsg" parameterType="int">
		insert into usermsg(user_id) value(#{userId})
	</insert>
	
	<!-- 更新用户资料 -->
	<update id="updateUsermsg" parameterType="userMessage">
    		update usermsg
			<set>
					<if test="name!=null">
    					name=#{name},
		    		</if>
		    		<if test="birth!=null">
	    				birth=#{birth},
		    		</if>
		    		<if test="age!=null">
	    				age=#{age},
		    		</if>
		    		<if test="idCard!=null">
	    				idCard=#{idCard},
		    		</if>
		    		<if test="province!=null">
	    				province=#{province},
		    		</if>
		    		<if test="city!=null">
    					city=#{city},
		    		</if>
		    		<if test="county!=null">
	    				county=#{county},
		    		</if>
		    		<if test="sex!=null">
	    				sex=#{sex},
		    		</if>
		    		<if test="phone!=null">
	    				phone=#{phone},
		    		</if>
		    		<if test="descs!=null">
	    				descs=#{descs},
		    		</if>
	    				ageState=#{ageState},
	    				msgState=#{msgState}
			</set>
    		where user_id=#{userId}
	</update>
	
	<select id="findUsermsg" parameterType="int" resultType="userMessage">
		select * from usermsg where user_id=#{userId}
	</select>
	
	<!-- 获取项目信息 -->
	<select id="findPro" parameterType="int" resultType="proMsg">
		select proadd address,proName name,descs from proadds where user_id=#{userId}
	</select>
	
	<!-- 插入项目信息 -->
	<insert id="addPro" parameterType="proMsg">
		insert into proadds(user_id,proadd,proName,descs) value(#{userId},#{address},#{name},#{descs})
	</insert>
	
	<!-- 更新项目信息 -->
	<update id="upPro" parameterType="proMsg">
		update proadds set proadd=#{address},proName=#{name},descs=#{descs} where user_id=#{id}
	</update>
		
	<!-- 获取git主页 -->
	<select id="findGit" parameterType="int" resultType="string">
		select gitHome from userstate where user_id=#{userId}
	</select>	
		
	<!-- 更新git主页 -->
	<update id="upGit" parameterType="map">
		update userstate set gitHome=#{gitHome} where user_id=#{userId}
	</update>
        
</mapper>